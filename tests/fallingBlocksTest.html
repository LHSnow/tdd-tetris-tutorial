<!DOCTYPE html>

<!--
  Copyright (c) 2008-2012  Esko Luontola <www.orfjackal.net> and Lars Bergström <harhund.com>
  You may use and modify this source code freely for personal non-commercial use.
  This source code may NOT be used as course material without prior written agreement.

  @author Esko Luontola <www.orfjackal.net> (original Java/junit examples)
  @author Lars Bergström <harhund.com> (adaptation to Javascript/qunit)
-->
 
<html>
<head>
  <meta charset="utf-8">
  <title>Falling blocks test</title>
  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.11.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
</body>

<script src="../src/board.js"></script>
<script src="../src/block.js"></script>
<script src="../src/piece.js"></script>
<script src="http://code.jquery.com/qunit/qunit-1.11.0.js"></script>
<script>

var board;

module("A new board", {
  setup: function() {
    board = new Board(3,3);
  }
});

test("is empty", function() {
  equal(board.toString(), "" +
        "...\n" +
        "...\n" +
        "...\n" );
});

test("has no falling blocks", function() {
  ok(!board.hasFalling());
});


module("When a block is dropped", {
  setup: function() {
    board = new Board(3,3);
    board.drop(new Piece('X'))
  }
});


test("the block is falling", function() {
  ok(board.hasFalling());
});

test("it starts from the top middle", function() {
    equal(board.toString(), "" +
            ".X.\n" +
            "...\n" +
            "...\n");
});

test("it moves down one row per tick", function() {
    board.tick();
    equal(board.toString(), "" +
            "...\n" +
            ".X.\n" +
            "...\n");
});

test("at most one block may be falling at a time", function() {
    try {
        board.drop(new Piece('Y'));
        ok(false, "exception expected"); //fail!
    } catch (e) {
        ok(e.indexOf("already falling") !== -1);
    }
    equal(board.toString(), "" +
            ".X.\n" +
            "...\n" +
            "...\n");
});



module("When a block reaches the bottom", {
  setup: function() {
    board = new Board(3,3);
    //fall to last row 
    board.drop(new Piece('X'));
    board.tick();
    board.tick();
  }
}); 

test("it is still falling on the last row", function() {
    equal(board.toString(), "" +
            "...\n" +
            "...\n" +
            ".X.\n");
    ok(board.hasFalling(), "the player should still be able to move the block");
});

test("it stops when it hits the bottom", function() {
    board.tick();
    ok(!board.hasFalling(), "the block should stop moving");
    equal(board.toString(), "" +
            "...\n" +
            "...\n" +
            ".X.\n");  
});




module("When a block lands on another block", {
  setup: function() {
    board = new Board(3,3);
    board.drop(new Piece('X'));
    board.tick();
    board.tick();
    board.tick();
    equal(board.toString(), "" +
            "...\n" +
            "...\n" +
            ".X.\n");
    ok(!board.hasFalling());

    board.drop(new Piece('Y'));
    board.tick();
  }  
});


test("it is still falling right above the other block", function() {
    equal(board.toString(), "" +
            "...\n" +
            ".Y.\n" +
            ".X.\n");
    ok(board.hasFalling(), "the player should still be able to avoid landing on the other block");
});

test("it stops when it hits the other block", function() {
    board.tick();
    equal(board.toString(), "" +
            "...\n" +
           ".Y.\n" +
            ".X.\n");
    ok(!board.hasFalling(), "the block should stop moving when it lands on the other block");
});

</script>
</html> 
